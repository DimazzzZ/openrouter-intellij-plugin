<!-- Plugin Configuration File. Read more: https://plugins.jetbrains.com/docs/intellij/plugin-configuration-file.html -->
<idea-plugin require-restart="false">
    <!-- Unique identifier of the plugin. It should be FQN. It cannot be changed between the plugin versions. -->
    <id>org.zhavoronkov.openrouter</id>

    <!-- Enable dynamic plugin support - allows install/update/uninstall without IDE restart -->
    <idea-version since-build="232" until-build="252.*"/>

    <!-- Public plugin name should be written in Title Case.
         Guidelines: https://plugins.jetbrains.com/docs/marketplace/plugin-overview-page.html#plugin-name -->
    <name>OpenRouter</name>

    <!-- A displayed Vendor name or Organization ID displayed on the Plugins Page. -->
    <vendor email="openrouter-plugin@zhavoronkov.org" url="https://github.com/DimazzzZ/openrouter-intellij-plugin">Dmitry Zhavoronkov</vendor>

    <!-- Description of the plugin displayed on the Plugin Page and IDE Plugin Manager.
         Simple HTML elements (text formatting, paragraphs, and lists) can be added inside this element.
         Guidelines: https://plugins.jetbrains.com/docs/marketplace/plugin-overview-page.html#plugin-description -->
    <description><![CDATA[
    <p><strong>OpenRouter IntelliJ Plugin</strong> - Comprehensive integration with <a href="https://openrouter.ai">OpenRouter.ai</a> for accessing 400+ AI models with advanced usage monitoring, quota tracking, OAuth/PKCE authentication, and AI Assistant proxy support.</p>

    <h3>Key Features</h3>
    <ul>
        <li><strong>ğŸ” OAuth/PKCE Authentication</strong> - Secure authentication flow with automatic API key generation</li>
        <li><strong>ğŸš€ AI Assistant Proxy</strong> - Local OpenAI-compatible proxy to connect JetBrains AI Assistant with OpenRouter's 400+ models</li>
        <li><strong>ğŸ“Š Interactive Status Bar Widget</strong> - Real-time usage display with comprehensive popup menu</li>
        <li><strong>ğŸ”‘ Advanced API Key Management</strong> - Secure provisioning key support with scope-aware validation</li>
        <li><strong>ğŸ“ˆ Detailed Usage Analytics</strong> - Track token consumption, costs, and model performance</li>
        <li><strong>â­ Favorite Models</strong> - Quick access to your preferred AI models</li>
        <li><strong>ğŸ”„ Dynamic Plugin Support</strong> - Install, update, and uninstall without IDE restart</li>
        <li><strong>ğŸ¯ Real-time Monitoring</strong> - Live connection status with color-coded indicators</li>
    </ul>

    <h3>Quick Start</h3>
    <ol>
        <li>Install the plugin (no restart required!)</li>
        <li>Use OAuth/PKCE flow or manually add your Provisioning Key from <a href="https://openrouter.ai/settings/provisioning-keys">OpenRouter</a></li>
        <li>Configure in <strong>Settings â†’ Tools â†’ OpenRouter</strong></li>
        <li>Click the status bar widget to access all features</li>
        <li>(Optional) Configure AI Assistant to use OpenRouter via custom server - <a href="https://github.com/DimazzzZ/openrouter-intellij-plugin/blob/main/docs/AI_ASSISTANT_SETUP.md">Setup Guide</a></li>
    </ol>

    <h3>Perfect For</h3>
    <ul>
        <li>Developers using AI models for code assistance via AI Assistant</li>
        <li>Teams monitoring AI usage and costs across multiple models</li>
        <li>Anyone wanting secure access to 400+ AI models from 40+ providers</li>
    </ul>

    <p><em>This is an unofficial plugin and is not affiliated with OpenRouter.ai or JetBrains.</em></p>
  ]]></description>

    <!-- Product and plugin compatibility requirements.
         Read more: https://plugins.jetbrains.com/docs/intellij/plugin-compatibility.html -->
    <depends>com.intellij.modules.platform</depends>

    <!--
         AI Assistant Integration Note:
         This plugin provides a local proxy server for AI Assistant integration.
         No plugin dependency is needed - AI Assistant connects via custom server configuration.
         See docs/AI_ASSISTANT_SETUP.md for setup instructions.
    -->


    <!-- Change notes for this version -->
    <change-notes><![CDATA[
        <h3>Version 0.4.2 - Multimodal Support (2026-01-20)</h3>
        <p><strong>Improvements:</strong></p>
        <ul>
            <li><strong>Multimodal Support</strong> - Added support for image, audio, and video content with AI models</li>
            <li><strong>Test Coverage</strong> - Added automated tests for multimodal capabilities</li>
        </ul>

        <hr/>

        <h3>ğŸ”§ Version 0.4.1 - SSE Streaming Fix & Logging Improvements (2025-12-23)</h3>
        <p><strong>ğŸ› Bug Fixes:</strong></p>
        <ul>
            <li><strong>Fixed AI Assistant Streaming</strong> - Fixed SSE format to comply with specification (blank line separators)</li>
            <li><strong>Stream Termination</strong> - All streams now properly end with [DONE] marker</li>
            <li><strong>Error Handling</strong> - Fixed error response SSE format with proper event separators</li>
        </ul>

        <p><strong>ğŸ“ Logging Improvements:</strong></p>
        <ul>
            <li><strong>Reduced Log Noise</strong> - Moved verbose logging to DEBUG level (78% reduction in INFO logs)</li>
            <li><strong>Standardized Request IDs</strong> - All logs use consistent [Chat-XXXXXX] format</li>
            <li><strong>Request Duration Metrics</strong> - Added duration tracking to completion logs</li>
            <li><strong>Fixed Log Levels</strong> - Normal API requests no longer logged as WARN</li>
        </ul>

        <p><strong>ğŸ§ª Testing:</strong></p>
        <ul>
            <li><strong>11 New SSE Tests</strong> - SSE format compliance and regression tests</li>
            <li><strong>AI Assistant Compatibility</strong> - Tests verify proper event separation and no JSON concatenation</li>
        </ul>

        <hr/>

        <h3>ğŸ‰ Version 0.4.0 - OAuth/PKCE Authentication & Dynamic Plugin Support (2025-12-22)</h3>
        <p><strong>ğŸ” Authentication & Security:</strong></p>
        <ul>
            <li><strong>OAuth/PKCE Authentication Flow</strong> - Secure PKCE authentication with OAuth code exchange for automatic API key generation</li>
            <li><strong>Scope-Aware Key Management</strong> - Unified API and provisioning key handling with comprehensive validation</li>
            <li><strong>Enhanced Key Validation</strong> - Centralized error messages and improved user feedback for authentication issues</li>
            <li><strong>Secure Key Storage</strong> - Encrypted local storage with duplicate prevention</li>
        </ul>

        <p><strong>ğŸ”„ Dynamic Plugin Support (NEW!):</strong></p>
        <ul>
            <li><strong>No Restart Required</strong> - Install, update, and uninstall plugin without restarting IDE</li>
            <li><strong>Proper Resource Cleanup</strong> - All services implement Disposable with graceful shutdown</li>
            <li><strong>Lifecycle Management</strong> - PluginLifecycleListener tracks load/unload events with detailed logging</li>
            <li><strong>Memory Leak Prevention</strong> - Jetty server shutdown, HTTP client cleanup, async task cancellation</li>
            <li><strong>State Persistence</strong> - Settings and tracking data saved before plugin unload</li>
        </ul>

        <p><strong>ğŸ—ï¸ Code Quality & Architecture:</strong></p>
        <ul>
            <li><strong>Setup Wizard Refactoring</strong> - Extracted 4 helper classes (PkceAuthHandler, SetupWizardConfig, ErrorHandler, Logger)</li>
            <li><strong>New Utility Classes</strong> - OpenRouterConstants, UIConstants, ErrorMessages, KeyValidator for better organization</li>
            <li><strong>Comprehensive Tests</strong> - 312-line authentication suite + dynamic plugin support tests with MockWebServer</li>
            <li><strong>Service Improvements</strong> - Dynamic URL generation, enhanced logging, improved testability</li>
            <li><strong>Disposable Implementation</strong> - All 4 core services properly clean up resources on plugin unload</li>
        </ul>

        <p><strong>ğŸ“Š Technical Stats:</strong></p>
        <ul>
            <li><strong>38+ files changed</strong> - 3,800+ insertions, 550+ deletions</li>
            <li><strong>13 new files</strong> - Utilities, handlers, listeners, tests, and documentation</li>
            <li><strong>Reduced complexity</strong> - SetupWizardDialog reduced from 1,194 to 1,048 lines</li>
            <li><strong>Full IntelliJ compliance</strong> - Meets all dynamic plugin requirements and restrictions</li>
        </ul>

        <p><a href="https://github.com/DimazzzZ/openrouter-intellij-plugin/blob/main/docs/AI_ASSISTANT_SETUP.md">AI Assistant Setup Guide</a> | <a href="https://github.com/DimazzzZ/openrouter-intellij-plugin/blob/main/CHANGELOG.md">Full Changelog</a></p>

        <hr/>

        <h3>ğŸ‰ Version 0.3.0 - Enhanced User Experience (2025-12-05)</h3>
        <p><strong>New Features:</strong></p>
        <ul>
            <li><strong>ğŸ‘‹ Setup Wizard</strong> - Interactive onboarding dialog for first-time users</li>
            <li><strong>ğŸ” Advanced Model Filtering</strong> - Filter models by provider, context window, and capabilities</li>
            <li><strong>ğŸ“Š Modal Statistics Dialog</strong> - Enhanced statistics popup with proper modal behavior</li>
        </ul>

        <p><strong>Quality & Stability:</strong></p>
        <ul>
            <li><strong>300+ Tests</strong> - Comprehensive test coverage with 100+ new tests</li>
            <li><strong>Bug Fixes</strong> - Crash prevention and improved dialog behavior</li>
            <li><strong>IDE 2025.3.X Support</strong> - Extended compatibility for Rider and other IDEs up to 2025.3+</li>
            <li><strong>Enhanced Error Handling</strong> - Better network error recovery and user feedback</li>
        </ul>

        <p><a href="https://github.com/DimazzzZ/openrouter-intellij-plugin/blob/main/docs/AI_ASSISTANT_SETUP.md">AI Assistant Setup Guide</a> | <a href="https://github.com/DimazzzZ/openrouter-intellij-plugin/blob/main/CHANGELOG.md">Full Changelog</a></p>

        <hr/>

        <h3>ğŸ‰ Version 0.2.1 - OpenRouter models support for 3rd-party AI Assistants (2025-10-04)</h3>
        <ul>
            <li>fix: resolve JetBrains plugin verifier compatibility issues and optimize workflows</li>
        </ul>

        <h3>ğŸ‰ Version 0.2.0 - OpenRouter models support for 3rd-party AI Assistants (2025-10-03)</h3>
        <p><strong>New Features:</strong></p>
        <ul>
            <li><strong>ğŸ¤– AI Assistant Proxy</strong> - Local OpenAI-compatible proxy server to connect JetBrains AI Assistant with OpenRouter's 400+ models</li>
            <li><strong>â­ Favorite Models</strong> - Manage and organize your preferred AI models</li>
            <li><strong>ğŸŒ Custom Server Support</strong> - Configure AI Assistant to use OpenRouter via custom model connection</li>
        </ul>

        <p><strong>Improvements:</strong></p>
        <ul>
            <li><strong>207+ Tests</strong> - Comprehensive test coverage with 100% pass rate</li>
            <li><strong>Zero Critical Code Smells</strong> - Enhanced code quality and maintainability</li>
            <li><strong>Better Performance</strong> - API key caching and optimized request handling</li>
            <li><strong>Modern UI</strong> - Updated to IntelliJ UI DSL v2</li>
        </ul>

        <p><a href="https://github.com/DimazzzZ/openrouter-intellij-plugin/blob/main/docs/AI_ASSISTANT_SETUP.md">AI Assistant Setup Guide</a> | <a href="https://github.com/DimazzzZ/openrouter-intellij-plugin/blob/main/CHANGELOG.md">Full Changelog</a></p>

        <hr/>

        <h3>Version 0.1.0 - Initial Release (2025-09-18)</h3>
        <p>First beta release of the OpenRouter IntelliJ Plugin with comprehensive OpenRouter.ai integration.</p>

        <p><strong>Key Features:</strong></p>
        <ul>
            <li><strong>Interactive Status Bar Widget</strong> - Real-time usage display with comprehensive popup menu</li>
            <li><strong>Advanced API Key Management</strong> - Provisioning key support with automatic API key creation</li>
            <li><strong>Detailed Usage Analytics</strong> - Track token consumption, costs, and model performance</li>
            <li><strong>Smart Settings Panel</strong> - Configuration with validation and testing</li>
            <li><strong>Statistics Popup</strong> - Modal dialog with comprehensive usage analytics</li>
            <li><strong>Multi-IDE Support</strong> - Works across all JetBrains IDEs (2023.2+)</li>
        </ul>

        <p><strong>Technical Highlights:</strong></p>
        <ul>
            <li>Secure credential storage using IntelliJ's built-in storage</li>
            <li>Asynchronous API operations for smooth user experience</li>
            <li>Comprehensive error handling and user feedback</li>
            <li>22 passing tests ensuring reliability</li>
        </ul>
    ]]></change-notes>

    <!-- Extension points defined by the plugin.
         Read more: https://plugins.jetbrains.com/docs/intellij/plugin-extension-points.html -->
    <extensions defaultExtensionNs="com.intellij">
        <!-- Notification group for plugin updates and announcements -->
        <notificationGroup id="OpenRouter Updates"
                           displayType="BALLOON"
                           isLogByDefault="true"/>

        <!-- Notification group for model errors and warnings -->
        <notificationGroup id="OpenRouter Errors"
                           displayType="BALLOON"
                           isLogByDefault="true"/>

        <!-- Notification group for welcome and onboarding -->
        <notificationGroup id="OpenRouter Notifications"
                           displayType="BALLOON"
                           isLogByDefault="true"/>

        <!-- Application-level services -->
        <applicationService serviceImplementation="org.zhavoronkov.openrouter.services.OpenRouterService"/>
        <applicationService serviceImplementation="org.zhavoronkov.openrouter.services.OpenRouterSettingsService"/>
        <applicationService serviceImplementation="org.zhavoronkov.openrouter.services.OpenRouterGenerationTrackingService"/>
        <applicationService serviceImplementation="org.zhavoronkov.openrouter.services.OpenRouterProxyService"/>
        
        <!-- Settings -->
        <applicationConfigurable
            parentId="tools"
            instance="org.zhavoronkov.openrouter.settings.OpenRouterConfigurable"
            id="org.zhavoronkov.openrouter.settings.OpenRouterConfigurable"
            displayName="OpenRouter"/>

        <!-- Favorite Models sub-page -->
        <applicationConfigurable
            parentId="org.zhavoronkov.openrouter.settings.OpenRouterConfigurable"
            instance="org.zhavoronkov.openrouter.settings.FavoriteModelsConfigurable"
            id="org.zhavoronkov.openrouter.settings.FavoriteModelsConfigurable"
            displayName="Favorite Models"/>
        
        <!-- Status bar widget -->
        <statusBarWidgetFactory
            implementation="org.zhavoronkov.openrouter.statusbar.OpenRouterStatusBarWidgetFactory"
            id="OpenRouterStatusBar"
            order="after Encoding"/>

        <!-- Startup activities -->
        <postStartupActivity implementation="org.zhavoronkov.openrouter.startup.WelcomeNotificationActivity"/>
        <postStartupActivity implementation="org.zhavoronkov.openrouter.startup.ProxyServerStartupActivity"/>
        <postStartupActivity implementation="org.zhavoronkov.openrouter.startup.WhatsNewNotificationActivity"/>

        <!-- Tool window - TEMPORARILY DISABLED -->
        <!--
        <toolWindow
            id="OpenRouter"
            secondary="true"
            icon="org.zhavoronkov.openrouter.icons.OpenRouterIcons.TOOL_WINDOW"
            anchor="right"
            factoryClass="org.zhavoronkov.openrouter.toolwindow.OpenRouterToolWindowFactory"/>
        -->
    </extensions>

    <!-- Application-level listeners for dynamic plugin support -->
    <applicationListeners>
        <listener
            class="org.zhavoronkov.openrouter.listeners.PluginLifecycleListener"
            topic="com.intellij.ide.plugins.DynamicPluginListener"/>
    </applicationListeners>

    <!-- Actions -->
    <actions>
        <group id="OpenRouter.ActionGroup" text="OpenRouter" description="OpenRouter actions">
            <add-to-group group-id="ToolsMenu" anchor="last"/>

            <action id="OpenRouter.ShowUsage"
                    class="org.zhavoronkov.openrouter.actions.ShowUsageAction"
                    text="Show Usage Statistics"
                    description="Display OpenRouter API usage statistics"/>

            <action id="OpenRouter.RefreshQuota"
                    class="org.zhavoronkov.openrouter.actions.RefreshQuotaAction"
                    text="Refresh Quota"
                    description="Refresh OpenRouter API quota information"/>

            <action id="OpenRouter.OpenSettings"
                    class="org.zhavoronkov.openrouter.actions.OpenSettingsAction"
                    text="Settings..."
                    description="Open OpenRouter settings"/>
        </group>
    </actions>
</idea-plugin>
